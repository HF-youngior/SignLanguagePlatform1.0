<template>
  <div class="min-h-screen bg-gray-50">
    <!-- ÂØºËà™Ê†è -->
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <router-link to="/" class="text-2xl font-bold text-blue-600">ÊâãËØ≠ÊïôÂ≠¶Âπ≥Âè∞</router-link>
          </div>
          <div class="flex items-center space-x-4">
            <router-link to="/" class="text-gray-600 hover:text-blue-600">È¶ñÈ°µ</router-link>
            <router-link to="/learn" class="text-gray-600 hover:text-blue-600">Â≠¶‰π†</router-link>
            <router-link to="/translate" class="text-gray-600 hover:text-blue-600">ÁøªËØë</router-link>
            <router-link to="/profile" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              ÊàëÁöÑ
            </router-link>
          </div>
        </div>
      </div>
    </nav>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
    <main class="pt-8">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-gray-900 mb-4">üë• ÊàëÁöÑÁ§æÂå∫</h1>
          <p class="text-xl text-gray-600">ÊàëÂú®ËøôÈáåÊúâËØùËØ¥</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
          <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
          <div class="lg:col-span-2 space-y-6">
            <!-- ÂèëÂ∏ÉÂä®ÊÄÅ -->
            <el-card>
              <template #header>
                <span class="text-lg font-semibold">ËØ¥ÁÇπ‰ªÄ‰πàÔºö</span>
              </template>
              <div class="space-y-4">
                <div class="relative">
                  <el-input
                    type="textarea"
                    :rows="3"
                    placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÂ≠¶‰π†ÂøÉÂæó„ÄÅÈÅáÂà∞ÁöÑÈóÆÈ¢òÊàñËÄÖÂ≠¶‰π†ÊäÄÂ∑ß...&#10;‰ΩøÁî®#Ê∑ªÂä†ËØùÈ¢òÊ†áÁ≠æ"
                    v-model="newPost"
                    @input="handleHashtagInput"
                  ></el-input>
                  
                  <!-- ËØùÈ¢òÊ†áÁ≠æÂª∫ËÆÆÊ°Ü -->
                  <div v-if="showHashtagSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-10 mt-1 max-h-48 overflow-y-auto">
                    <div class="p-2">
                      <div class="text-xs text-gray-500 mb-2">ÁÉ≠Èó®ËØùÈ¢ò</div>
                      <div v-for="topic in hashtagSuggestions" :key="topic.id" 
                           class="flex items-center justify-between p-2 hover:bg-gray-100 cursor-pointer rounded"
                           @click="selectHashtag(topic)">
                        <span class="text-blue-600">#{{ topic.name }}</span>
                        <span class="text-xs text-gray-500">{{ topic.count }} ËÆ®ËÆ∫</span>
                      </div>
                      <div v-if="newHashtag.trim()" 
                           class="flex items-center justify-between p-2 hover:bg-gray-100 cursor-pointer rounded border-t border-gray-200 mt-2"
                           @click="createNewHashtag">
                        <span class="text-green-600">ÂàõÂª∫Êñ∞ËØùÈ¢ò: #{{ newHashtag }}</span>
                        <span class="text-xs text-green-500">Êñ∞Âª∫</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ‰∏ä‰º†ÁöÑÂõæÁâáÈ¢ÑËßà -->
                <div v-if="uploadedImages.length > 0" class="space-y-2">
                  <div class="text-sm text-gray-600">Â∑≤‰∏ä‰º†ÂõæÁâáÔºö</div>
                  <div class="flex flex-wrap gap-2">
                    <div v-for="image in uploadedImages" :key="image.id" class="relative">
                      <img :src="image.url" :alt="image.name" class="w-20 h-20 object-cover rounded border">
                      <button @click="removeImage(image.id)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">√ó</button>
                    </div>
                  </div>
                </div>

                <!-- ‰∏ä‰º†ÁöÑËßÜÈ¢ëÈ¢ÑËßà -->
                <div v-if="uploadedVideos.length > 0" class="space-y-2">
                  <div class="text-sm text-gray-600">Â∑≤‰∏ä‰º†ËßÜÈ¢ëÔºö</div>
                  <div class="space-y-2">
                    <div v-for="video in uploadedVideos" :key="video.id" class="relative">
                      <video :src="video.url" class="w-40 h-24 object-cover rounded border" controls></video>
                      <button @click="removeVideo(video.id)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">√ó</button>
                      <div class="text-xs text-gray-500 mt-1">{{ video.name }}</div>
                    </div>
                  </div>
                </div>

                <div class="flex justify-between items-center">
                  <div class="flex space-x-2">
                    <input
                      ref="imageInput"
                      type="file"
                      accept="image/*"
                      multiple
                      style="display: none"
                      @change="handleImageUpload"
                    >
                    <el-button size="small" icon="Picture" @click="imageInput.click()">ÂõæÁâá</el-button>
                    
                    <input
                      ref="videoInput"
                      type="file"
                      accept="video/*"
                      multiple
                      style="display: none"
                      @change="handleVideoUpload"
                    >
                    <el-button size="small" icon="VideoCamera" @click="videoInput.click()">ËßÜÈ¢ë</el-button>
                  </div>
                  <el-button type="primary" @click="publishPost">ÂèëÂ∏É</el-button>
                </div>
              </div>
            </el-card>

            <!-- Âä®ÊÄÅÂàóË°® -->
            <div class="space-y-4">
              <el-card v-for="post in posts" :key="post.id" class="hover:shadow-lg transition-shadow">
                <div class="flex items-start space-x-4">
                  <el-avatar :size="50" :src="post.avatar">
                    {{ post.username.charAt(0) }}
                  </el-avatar>
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="font-semibold">{{ post.username }}</span>
                      <el-tag size="small" :type="post.level === 'ÂàùÁ∫ß' ? 'info' : post.level === '‰∏≠Á∫ß' ? 'warning' : 'success'">
                        {{ post.level }}
                      </el-tag>
                      <span class="text-gray-500 text-sm">{{ post.time }}</span>
                    </div>
                    <p class="text-gray-700 mb-3">{{ post.content }}</p>
                    
                    <!-- ÊòæÁ§∫Â∏ñÂ≠ê‰∏≠ÁöÑÂõæÁâá -->
                    <div v-if="post.images && post.images.length > 0" class="mb-3">
                      <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <img v-for="image in post.images" :key="image.id" :src="image.url" :alt="image.name" class="w-full h-32 object-cover rounded border cursor-pointer hover:opacity-80" @click="openImageModal(image.url)">
                      </div>
                    </div>

                    <!-- ÊòæÁ§∫Â∏ñÂ≠ê‰∏≠ÁöÑËßÜÈ¢ë -->
                    <div v-if="post.videos && post.videos.length > 0" class="mb-3">
                      <video v-for="video in post.videos" :key="video.id" :src="video.url" class="w-full max-w-md rounded border" controls></video>
                    </div>
                    <div class="flex items-center space-x-4 text-gray-500 text-sm mb-4">
                      <span class="flex items-center cursor-pointer hover:text-blue-600" @click="toggleCommentInput(post.id)">
                        <el-icon class="mr-1"><ChatDotRound /></el-icon>
                        {{ post.comments }} ËØÑËÆ∫
                      </span>
                      <span class="flex items-center cursor-pointer hover:text-red-600" @click="toggleLike(post.id)">
                        <el-icon class="mr-1" :class="{ 'text-red-500': post.isLiked }"><Like /></el-icon>
                        {{ post.likes }} ÁÇπËµû
                      </span>
                    </div>

                    <!-- ËØÑËÆ∫ËæìÂÖ•Ê°Ü -->
                    <div v-if="showCommentInput[post.id]" class="mb-4">
                      <el-input
                        v-model="newComment"
                        type="textarea"
                        :rows="2"
                        placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..."
                        class="mb-2"
                      ></el-input>
                      <div class="flex justify-end space-x-2">
                        <el-button size="small" @click="showCommentInput[post.id] = false">ÂèñÊ∂à</el-button>
                        <el-button size="small" type="primary" @click="addComment(post.id)">ÂèëÂ∏ÉËØÑËÆ∫</el-button>
                      </div>
                    </div>

                    <!-- ËØÑËÆ∫ÂàóË°® -->
                    <div v-if="post.commentList && post.commentList.length > 0" class="border-t pt-4">
                      <div v-for="comment in post.commentList" :key="comment.id" class="mb-4">
                        <div class="flex items-start space-x-3">
                          <el-avatar :size="35" :src="comment.avatar">
                            {{ comment.username.charAt(0) }}
                          </el-avatar>
                          <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                              <span class="font-medium text-sm">{{ comment.username }}</span>
                              <span class="text-gray-500 text-xs">{{ comment.time }}</span>
                            </div>
                            <p class="text-gray-700 text-sm mb-2">{{ comment.content }}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                              <span class="cursor-pointer hover:text-blue-600" @click="toggleReplyInput(post.id, comment.id)">
                                ÂõûÂ§ç
                              </span>
                            </div>

                            <!-- ÂõûÂ§çËæìÂÖ•Ê°Ü -->
                            <div v-if="showReplyInput[`${post.id}-${comment.id}`]" class="mt-2">
                              <el-input
                                v-model="replyToComment[`${post.id}-${comment.id}`]"
                                type="textarea"
                                :rows="1"
                                placeholder="ÂõûÂ§ç @{{ comment.username }}..."
                                class="mb-2"
                              ></el-input>
                              <div class="flex justify-end space-x-2">
                                <el-button size="small" @click="showReplyInput[`${post.id}-${comment.id}`] = false">ÂèñÊ∂à</el-button>
                                <el-button size="small" type="primary" @click="addReply(post.id, comment.id)">ÂõûÂ§ç</el-button>
                              </div>
                            </div>

                            <!-- Ê•º‰∏≠Ê•ºÂõûÂ§ç -->
                            <div v-if="comment.replies && comment.replies.length > 0" class="mt-2 ml-4 border-l-2 border-gray-200 pl-3">
                              <div v-for="reply in comment.replies" :key="reply.id" class="mb-2">
                                <div class="flex items-start space-x-2">
                                  <el-avatar :size="25" :src="reply.avatar">
                                    {{ reply.username.charAt(0) }}
                                  </el-avatar>
                                  <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                      <span class="font-medium text-xs">{{ reply.username }}</span>
                                      <span v-if="reply.replyTo" class="text-blue-600 text-xs">@{{ reply.replyTo }}</span>
                                      <span class="text-gray-500 text-xs">{{ reply.time }}</span>
                                    </div>
                                    <p class="text-gray-700 text-xs">{{ reply.content }}</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </el-card>
            </div>
          </div>

          <!-- ‰æßËæπÊ†è -->
          <div class="space-y-6">
            <!-- ËÅãÂÅ•‰∫íÈÄöÁªÑÂà´ -->
            <el-card>
              <template #header>
                <span class="text-lg font-semibold">ü§ù ËÅãÂÅ•‰∫íÈÄö</span>
              </template>
              <div class="space-y-3">
                <div v-for="group in deafHearingGroups" :key="group.id" class="flex items-center space-x-3">
                  <el-avatar :size="40" :src="group.avatar" :class="group.type === 'deaf' ? 'ring-2 ring-green-500' : 'ring-2 ring-blue-500'">
                    {{ group.name.charAt(0) }}
                  </el-avatar>
                  <div class="flex-1">
                    <div class="font-medium">{{ group.name }}</div>
                    <div class="text-sm text-gray-500">{{ group.members }} ÊàêÂëò</div>
                    <div class="text-xs text-gray-400">{{ group.description }}</div>
                  </div>
                  <el-button size="small" type="success" plain @click="joinGroup(group)">Âä†ÂÖ•</el-button>
                </div>
              </div>
            </el-card>

            <!-- ÁÉ≠Èó®ËØùÈ¢ò -->
            <el-card>
              <template #header>
                <span class="text-lg font-semibold">üî• ÁÉ≠Èó®ËØùÈ¢ò</span>
              </template>
              <div class="space-y-2">
                <div v-for="topic in hotTopics" :key="topic.id" class="flex items-center justify-between">
                  <span class="text-blue-600 cursor-pointer hover:underline" @click="goToHashtagPage(topic)">{{ topic.name }}</span>
                  <el-tag size="small" type="danger">{{ topic.count }}</el-tag>
                </div>
              </div>
            </el-card>

            <!-- ÁÉ≠Èó®Áæ§ËÅä -->
            <el-card>
              <template #header>
                <span class="text-lg font-semibold">üî• ÁÉ≠Èó®Áæ§ËÅä</span>
              </template>
              <div class="space-y-3">
                <div v-for="group in hotChatGroups" :key="group.id" class="flex items-center space-x-3">
                  <el-avatar :size="40" :src="group.avatar">{{ group.name.charAt(0) }}</el-avatar>
                  <div class="flex-1">
                    <div class="font-medium">{{ group.name }}</div>
                    <div class="text-sm text-gray-500">{{ group.members }} ÊàêÂëò ¬∑ {{ group.activeToday }} ‰ªäÊó•Ê¥ªË∑É</div>
                  </div>
                  <el-button size="small" type="primary" plain @click="joinChatGroup(group)">Âä†ÂÖ•</el-button>
                </div>
              </div>
            </el-card>
          </div>
        </div>
      </div>
    </main>

    <!-- È°µËÑö -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p>&copy; 2025 ÊâãËØ≠ÊïôÂ≠¶Âπ≥Âè∞. All rights reserved.</p>
      </div>
    </footer>
  </div>
</template>

<script>
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { useRouter } from 'vue-router'

export default {
  name: 'Community',
  setup() {
    const router = useRouter()
    const newPost = ref('')
    const newComment = ref('')
    const showCommentInput = ref({})
    const showReplyInput = ref({})
    const replyToComment = ref({})
    const uploadedImages = ref([])
    const uploadedVideos = ref([])
    const imageInput = ref(null)
    const videoInput = ref(null)
    const showHashtagSuggestions = ref(false)
    const hashtagSuggestions = ref([])
    const hashtagCursorPosition = ref(0)
    const newHashtag = ref('')

    const posts = ref([
      {
        id: 1,
        username: 'Â∞èÊòé',
        level: 'ÂàùÁ∫ß',
        time: '2Â∞èÊó∂Ââç',
        content: '‰ªäÂ§©Â≠¶‰ºö‰∫Ü"‰Ω†Â•Ω"ÁöÑÊâãËØ≠Ë°®ËææÔºåÊÑüËßâÂæàÊúâÊàêÂ∞±ÊÑüÔºÅÂ§ßÂÆ∂Êúâ‰ªÄ‰πàÂ≠¶‰π†ÊäÄÂ∑ßÂèØ‰ª•ÂàÜ‰∫´ÂêóÔºü',
        avatar: '',
        comments: 5,
        likes: 12,
        isLiked: false,
        commentList: [
          {
            id: 1,
            username: 'Â∞èÁ∫¢',
            content: 'ÂæàÊ£íÔºÅÂª∫ËÆÆÂ§öÁªÉ‰π†Âü∫Á°ÄÊâãÂäø',
            time: '1Â∞èÊó∂Ââç',
            replies: [
              {
                id: 11,
                username: 'Â∞èÊòé',
                content: 'Ë∞¢Ë∞¢Âª∫ËÆÆÔºÅ',
                time: '30ÂàÜÈíüÂâç',
                replyTo: 'Â∞èÁ∫¢'
              }
            ]
          },
          {
            id: 2,
            username: 'ËÄÅÂ∏à',
            content: 'ÂèØ‰ª•Â∞ùËØïÂØπÁùÄÈïúÂ≠êÁªÉ‰π†ÔºåËßÇÂØüÊâãÂäøÊòØÂê¶Ê†áÂáÜ',
            time: '45ÂàÜÈíüÂâç',
            replies: []
          }
        ]
      },
      {
        id: 2,
        username: 'Â∞èÁ∫¢',
        level: '‰∏≠Á∫ß',
        time: '4Â∞èÊó∂Ââç',
        content: 'ÂàÜ‰∫´‰∏Ä‰∏™Â≠¶‰π†ÂøÉÂæóÔºöÊØèÂ§©ÂùöÊåÅÁªÉ‰π†15ÂàÜÈíüÔºåÊØî‰∏ÄÊ¨°ÊÄßÁªÉ‰π†2Â∞èÊó∂ÊïàÊûúÊõ¥Â•Ω„ÄÇÂæ™Â∫èÊ∏êËøõÂæàÈáçË¶ÅÔºÅ',
        avatar: '',
        comments: 8,
        likes: 23,
        isLiked: false,
        commentList: [
          {
            id: 3,
            username: 'ËÄÅÂ∏à',
            content: 'ÈùûÂ∏∏ËµûÂêåÔºÅË¥®ÈáèÊØîÊï∞ÈáèÊõ¥ÈáçË¶Å',
            time: '3Â∞èÊó∂Ââç',
            replies: []
          }
        ]
      },
      {
        id: 3,
        username: 'ËÄÅÂ∏à',
        level: 'È´òÁ∫ß',
        time: '6Â∞èÊó∂Ââç',
        content: 'Êú¨Âë®ÁöÑÊåëÊàòÔºöÂ≠¶‰ºöÁî®ÊâãËØ≠Ë°®Ëææ"‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω"„ÄÇÂ§ßÂÆ∂ÂèØ‰ª•Â∞ùËØï‰∏Ä‰∏ãÔºåÊúâÈóÆÈ¢òÈöèÊó∂ÊèêÈóÆÔºÅ',
        avatar: '',
        comments: 15,
        likes: 45,
        isLiked: false,
        commentList: [
          {
            id: 4,
            username: 'Â∞èÊòé',
            content: 'ËÄÅÂ∏àÔºåËøô‰∏™ÊâãÂäøÊÄé‰πàÂÅöÔºü',
            time: '5Â∞èÊó∂Ââç',
            replies: [
              {
                id: 41,
                username: 'ËÄÅÂ∏à',
                content: 'ÂÖàÂÅö"‰ªäÂ§©"ÔºåÁÑ∂ÂêéÂÅö"Â§©Ê∞î"ÔºåÊúÄÂêéÂÅö"ÂæàÂ•Ω"',
                time: '4Â∞èÊó∂Ââç',
                replyTo: 'Â∞èÊòé'
              }
            ]
          }
        ]
      }
    ])


    const hotTopics = ref([
      { id: 1, name: '#ÊâãËØ≠Â≠óÊØçÂ≠¶‰π†', count: 156 },
      { id: 2, name: '#Êó•Â∏∏ÂØπËØù', count: 89 },
      { id: 3, name: '#Â≠¶‰π†ÂøÉÂæó', count: 67 },
      { id: 4, name: '#AIÁøªËØë', count: 45 },
      { id: 5, name: '#Â≠¶‰π†ËÆ°Âàí', count: 32 },
      { id: 6, name: '#ËÅãÂÅ•‰∫§ÊµÅ', count: 78 },
      { id: 7, name: '#ËÅã‰∫∫ÊñáÂåñ', count: 56 },
      { id: 8, name: '#ÊâãËØ≠Â∑ÆÂºÇ', count: 43 }
    ])

    const hotChatGroups = ref([
      { id: 1, name: 'ÊâãËØ≠Êó•Â∏∏ÂØπËØù', members: 234, activeToday: 45, avatar: '' },
      { id: 2, name: 'AIÁøªËØëËÆ®ËÆ∫ÁªÑ', members: 189, activeToday: 38, avatar: '' },
      { id: 3, name: 'ËÅã‰∫∫ÊñáÂåñÂàÜ‰∫´', members: 167, activeToday: 32, avatar: '' },
      { id: 4, name: 'ÊâãËØ≠Â≠¶‰π†ÊâìÂç°', members: 298, activeToday: 67, avatar: '' },
      { id: 5, name: 'Êñ∞ÊâãÊåáÂçóÁæ§', members: 145, activeToday: 28, avatar: '' }
    ])

    const deafHearingGroups = ref([
      { id: 1, name: 'ËÅãÂÅ•‰∫§ÊµÅÁªÑ', members: 120, avatar: '', type: 'mixed', description: 'ËÅã‰∫∫ÊúãÂèã‰∏éÂê¨ÂäõÊ≠£Â∏∏ÊúãÂèã‰∫§ÊµÅÁöÑÂπ≥Âè∞' },
      { id: 2, name: 'ËÅã‰∫∫ÊñáÂåñÂàÜ‰∫´ÁªÑ', members: 80, avatar: '', type: 'deaf', description: 'ÂàÜ‰∫´ËÅã‰∫∫ÊñáÂåñ„ÄÅËâ∫ÊúØ„ÄÅÁîüÊ¥ªÁªèÈ™å' },
      { id: 3, name: 'ÊâãËØ≠Â∑ÆÂºÇËÆ®ËÆ∫ÁªÑ', members: 95, avatar: '', type: 'mixed', description: 'ËÆ®ËÆ∫ÊïôÂ≠¶ÊâãËØ≠‰∏éËÅã‰∫∫ÂÆûÈôÖ‰ΩøÁî®ÊâãËØ≠ÁöÑÂ∑ÆÂºÇ' },
      { id: 4, name: 'ËÅã‰∫∫ÁîüÊ¥ªÁé∞Áä∂ÁªÑ', members: 65, avatar: '', type: 'mixed', description: '‰∫ÜËß£ËÅã‰∫∫ÁöÑÊó•Â∏∏ÁîüÊ¥ª„ÄÅÂ∑•‰Ωú„ÄÅÂ≠¶‰π†Áé∞Áä∂' }
    ])

    // Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
    const handleImageUpload = (event) => {
      const files = event.target.files
      if (files && files.length > 0) {
        Array.from(files).forEach(file => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader()
            reader.onload = (e) => {
              uploadedImages.value.push({
                id: Date.now() + Math.random(),
                url: e.target.result,
                name: file.name
              })
            }
            reader.readAsDataURL(file)
          } else {
            ElMessage.warning('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂')
          }
        })
      }
    }

    // Â§ÑÁêÜËßÜÈ¢ë‰∏ä‰º†
    const handleVideoUpload = (event) => {
      const files = event.target.files
      if (files && files.length > 0) {
        Array.from(files).forEach(file => {
          if (file.type.startsWith('video/')) {
            const reader = new FileReader()
            reader.onload = (e) => {
              uploadedVideos.value.push({
                id: Date.now() + Math.random(),
                url: e.target.result,
                name: file.name
              })
            }
            reader.readAsDataURL(file)
          } else {
            ElMessage.warning('ËØ∑ÈÄâÊã©ËßÜÈ¢ëÊñá‰ª∂')
          }
        })
      }
    }

    // Âà†Èô§Â∑≤‰∏ä‰º†ÁöÑÂõæÁâá
    const removeImage = (imageId) => {
      uploadedImages.value = uploadedImages.value.filter(img => img.id !== imageId)
    }

    // Âà†Èô§Â∑≤‰∏ä‰º†ÁöÑËßÜÈ¢ë
    const removeVideo = (videoId) => {
      uploadedVideos.value = uploadedVideos.value.filter(vid => vid.id !== videoId)
    }

    // ÂèëÂ∏ÉÊñ∞Â∏ñÂ≠ê
    const publishPost = () => {
      if (newPost.value.trim() || uploadedImages.value.length > 0 || uploadedVideos.value.length > 0) {
        const currentTime = new Date()
        const newPostObj = {
          id: Date.now(), // ‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫ÂîØ‰∏ÄID
          username: 'Êàë', // ÂΩìÂâçÁî®Êà∑
          level: 'ÂàùÁ∫ß',
          time: 'ÂàöÂàö',
          content: newPost.value.trim(),
          avatar: '',
          comments: 0,
          likes: 0,
          commentList: [],
          images: [...uploadedImages.value],
          videos: [...uploadedVideos.value]
        }
        
        // Â∞ÜÊñ∞Â∏ñÂ≠êÊ∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥
        posts.value.unshift(newPostObj)
        newPost.value = ''
        uploadedImages.value = []
        uploadedVideos.value = []
        ElMessage.success('ÂèëÂ∏ÉÊàêÂäüÔºÅ')
      } else {
        ElMessage.warning('ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñ‰∏ä‰º†ÂõæÁâá/ËßÜÈ¢ë')
      }
    }

    // ÂàáÊç¢ËØÑËÆ∫ËæìÂÖ•Ê°ÜÊòæÁ§∫
    const toggleCommentInput = (postId) => {
      showCommentInput.value[postId] = !showCommentInput.value[postId]
    }

    // ÂàáÊç¢ÂõûÂ§çËæìÂÖ•Ê°ÜÊòæÁ§∫
    const toggleReplyInput = (postId, commentId) => {
      const key = `${postId}-${commentId}`
      showReplyInput.value[key] = !showReplyInput.value[key]
      if (showReplyInput.value[key]) {
        replyToComment.value[key] = commentId
      }
    }

    // Ê∑ªÂä†ËØÑËÆ∫
    const addComment = (postId) => {
      if (newComment.value.trim()) {
        const post = posts.value.find(p => p.id === postId)
        if (post) {
          const newCommentObj = {
            id: Date.now(),
            username: 'Êàë',
            content: newComment.value.trim(),
            time: 'ÂàöÂàö',
            replies: []
          }
          
          post.commentList.push(newCommentObj)
          post.comments += 1
          newComment.value = ''
          showCommentInput.value[postId] = false
          ElMessage.success('ËØÑËÆ∫ÊàêÂäüÔºÅ')
        }
      } else {
        ElMessage.warning('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ')
      }
    }

    // Ê∑ªÂä†ÂõûÂ§ç
    const addReply = (postId, commentId) => {
      const key = `${postId}-${commentId}`
      const replyContent = replyToComment.value[key] || ''
      
      if (replyContent.trim()) {
        const post = posts.value.find(p => p.id === postId)
        if (post) {
          const comment = post.commentList.find(c => c.id === commentId)
          if (comment) {
            const newReplyObj = {
              id: Date.now(),
              username: 'Êàë',
              content: replyContent.trim(),
              time: 'ÂàöÂàö',
              replyTo: comment.username
            }
            
            comment.replies.push(newReplyObj)
            post.comments += 1
            replyToComment.value[key] = ''
            showReplyInput.value[key] = false
            ElMessage.success('ÂõûÂ§çÊàêÂäüÔºÅ')
          }
        }
      } else {
        ElMessage.warning('ËØ∑ËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ')
      }
    }

    // Âä†ÂÖ•ËÅãÂÅ•‰∫íÈÄöÂ∞èÁªÑ
    const joinGroup = (group) => {
      ElMessage.success(`Ê≠£Âú®Âä†ÂÖ• ${group.name}...`)
      // Ë∑≥ËΩ¨Âà∞Â∞èÁªÑËÅäÂ§©È°µÈù¢
      router.push(`/group-chat/${group.id}`)
    }

    // Âä†ÂÖ•ÁÉ≠Èó®Áæ§ËÅä
    const joinChatGroup = (group) => {
      ElMessage.success(`Ê≠£Âú®Âä†ÂÖ• ${group.name}...`)
      // Ë∑≥ËΩ¨Âà∞Áæ§ËÅäÈ°µÈù¢
      router.push(`/chat-group/${group.id}`)
    }

    // Â§ÑÁêÜËØùÈ¢òÊ†áÁ≠æËæìÂÖ•
    const handleHashtagInput = (event) => {
      const cursorPos = event.target.selectionStart
      const text = newPost.value
      const beforeCursor = text.substring(0, cursorPos)
      
      // Êü•ÊâæÊúÄËøëÁöÑ#Á¨¶Âè∑
      const lastHashtagIndex = beforeCursor.lastIndexOf('#')
      if (lastHashtagIndex !== -1) {
        const hashtagText = beforeCursor.substring(lastHashtagIndex + 1)
        // Ê£ÄÊü•#ÂêéÈù¢ÊòØÂê¶Âè™ÂåÖÂê´Â≠óÊØçÊï∞Â≠óÊàñ‰∏≠Êñá
        if (/^[\u4e00-\u9fa5a-zA-Z0-9]*$/.test(hashtagText) && !hashtagText.includes(' ')) {
          hashtagCursorPosition.value = lastHashtagIndex
          // ËøáÊª§ÁÉ≠Èó®ËØùÈ¢ò
          hashtagSuggestions.value = hotTopics.value.filter(topic => 
            topic.name.toLowerCase().includes(hashtagText.toLowerCase())
          )
          showHashtagSuggestions.value = true
          newHashtag.value = hashtagText
        } else {
          showHashtagSuggestions.value = false
        }
      } else {
        showHashtagSuggestions.value = false
      }
    }

    // ÈÄâÊã©ËØùÈ¢òÊ†áÁ≠æ
    const selectHashtag = (topic) => {
      const beforeCursor = newPost.value.substring(0, hashtagCursorPosition.value)
      const afterCursor = newPost.value.substring(newPost.value.indexOf('#', hashtagCursorPosition.value) + 1)
      const afterHashtag = afterCursor.substring(newHashtag.value.length)
      
      newPost.value = beforeCursor + '#' + topic.name + ' ' + afterHashtag
      showHashtagSuggestions.value = false
    }

    // ÂàõÂª∫Êñ∞ËØùÈ¢ò
    const createNewHashtag = () => {
      if (newHashtag.value.trim()) {
        const beforeCursor = newPost.value.substring(0, hashtagCursorPosition.value)
        const afterCursor = newPost.value.substring(newPost.value.indexOf('#', hashtagCursorPosition.value) + 1)
        const afterHashtag = afterCursor.substring(newHashtag.value.length)
        
        const hashtagName = newHashtag.value.trim()
        newPost.value = beforeCursor + '#' + hashtagName + ' ' + afterHashtag
        
        // Ê∑ªÂä†Âà∞ÁÉ≠Èó®ËØùÈ¢òÂàóË°®
        hotTopics.value.unshift({
          id: Date.now(),
          name: hashtagName,
          count: 1
        })
        
        showHashtagSuggestions.value = false
        newHashtag.value = ''
        ElMessage.success(`ËØùÈ¢ò #${hashtagName} ÂàõÂª∫ÊàêÂäüÔºÅ`)
      }
    }

    // Ë∑≥ËΩ¨Âà∞ËØùÈ¢òÈ°µÈù¢
    const goToHashtagPage = (topic) => {
      router.push(`/hashtag/${encodeURIComponent(topic.name)}`)
    }

    // ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
    const toggleLike = (postId) => {
      const post = posts.value.find(p => p.id === postId)
      if (post) {
        if (post.isLiked) {
          post.likes -= 1
          post.isLiked = false
          ElMessage.success('ÂèñÊ∂àÁÇπËµû')
        } else {
          post.likes += 1
          post.isLiked = true
          ElMessage.success('ÁÇπËµûÊàêÂäü')
        }
      }
    }

    return {
      newPost,
      newComment,
      showCommentInput,
      showReplyInput,
      replyToComment,
      uploadedImages,
      uploadedVideos,
      imageInput,
      videoInput,
      showHashtagSuggestions,
      hashtagSuggestions,
      hashtagCursorPosition,
      newHashtag,
      posts,
      hotTopics,
      hotChatGroups,
      deafHearingGroups,
      publishPost,
      toggleCommentInput,
      toggleReplyInput,
      addComment,
      addReply,
      handleImageUpload,
      handleVideoUpload,
      removeImage,
      removeVideo,
      joinGroup,
      joinChatGroup,
      handleHashtagInput,
      selectHashtag,
      createNewHashtag,
      goToHashtagPage,
      toggleLike
    }
  },
  mounted() {
    document.title = 'ÊàëÁöÑÁ§æÂå∫ - ÊâãËØ≠ÊïôÂ≠¶Âπ≥Âè∞'
  }
}
</script>
